---
- name: Install Homebrew applications on macOS
  hosts: localhost
  connection: local
  gather_facts: yes
  
  vars:
    homebrew_packages:
      - cloc
      - btop
      - awscli
      - imagemagick
      - wget
      - pipx
      - nmap
      - node@22
      - sbt
      - jq
      - handbrake
      - gradle
      - gh
      - cocoapods
      - ffmpeg
      - circleci
      - stow

  tasks:
    - name: Verify Apple Silicon architecture
      fail:
        msg: "This playbook only supports Apple Silicon Macs (arm64)"
      when: ansible_architecture != "arm64"
    
    - name: Check if Homebrew is installed
      stat:
        path: /opt/homebrew/bin/brew
      register: homebrew_check
      
    - name: Install Homebrew
      shell: /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
      when: not homebrew_check.stat.exists
      
    - name: Update Homebrew
      community.general.homebrew:
        update_homebrew: yes
        
    - name: Install Homebrew packages
      community.general.homebrew:
        name: "{{ item }}"
        state: present
      loop: "{{ homebrew_packages }}"
      
    - name: Verify installed packages
      command: brew list {{ item }}
      loop: "{{ homebrew_packages }}"
      register: package_verification
      changed_when: false
      
    - name: Display installation results
      debug:
        msg: "Successfully installed: {{ homebrew_packages | join(', ') }}"